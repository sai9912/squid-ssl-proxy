# ---- Listeners with SSL-bump + routing (placed at top) ----
http_port 10.0.45.192:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip01
http_port 10.0.43.161:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip02
http_port 10.0.47.130:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip03
http_port 10.0.32.68:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip04
http_port 10.0.33.229:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip05
http_port 10.0.40.37:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip06
http_port 10.0.37.39:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip07
http_port 10.0.39.40:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip08
http_port 10.0.32.9:8000   ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip09
http_port 10.0.32.44:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip10
http_port 10.0.32.172:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip11
http_port 10.0.37.141:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip12
http_port 10.0.44.47:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip13
http_port 10.0.45.113:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip14
http_port 10.0.32.81:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip15
http_port 10.0.34.114:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip16
http_port 10.0.38.115:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip17
http_port 10.0.47.22:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip18
http_port 10.0.33.24:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip19
http_port 10.0.36.254:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip20

# Route egress to match inbound listener
acl to_ip01 myportname ip01
acl to_ip02 myportname ip02
acl to_ip03 myportname ip03
acl to_ip04 myportname ip04
acl to_ip05 myportname ip05
acl to_ip06 myportname ip06
acl to_ip07 myportname ip07
acl to_ip08 myportname ip08
acl to_ip09 myportname ip09
acl to_ip10 myportname ip10
acl to_ip11 myportname ip11
acl to_ip12 myportname ip12
acl to_ip13 myportname ip13
acl to_ip14 myportname ip14
acl to_ip15 myportname ip15
acl to_ip16 myportname ip16
acl to_ip17 myportname ip17
acl to_ip18 myportname ip18
acl to_ip19 myportname ip19
acl to_ip20 myportname ip20

tcp_outgoing_address 10.0.45.192 to_ip01
tcp_outgoing_address 10.0.43.161 to_ip02
tcp_outgoing_address 10.0.47.130 to_ip03
tcp_outgoing_address 10.0.32.68  to_ip04
tcp_outgoing_address 10.0.33.229 to_ip05
tcp_outgoing_address 10.0.40.37  to_ip06
tcp_outgoing_address 10.0.37.39  to_ip07
tcp_outgoing_address 10.0.39.40  to_ip08
tcp_outgoing_address 10.0.32.9   to_ip09
tcp_outgoing_address 10.0.32.44  to_ip10
tcp_outgoing_address 10.0.32.172 to_ip11
tcp_outgoing_address 10.0.37.141 to_ip12
tcp_outgoing_address 10.0.44.47  to_ip13
tcp_outgoing_address 10.0.45.113 to_ip14
tcp_outgoing_address 10.0.32.81  to_ip15
tcp_outgoing_address 10.0.34.114 to_ip16
tcp_outgoing_address 10.0.38.115 to_ip17
tcp_outgoing_address 10.0.47.22  to_ip18
tcp_outgoing_address 10.0.33.24  to_ip19
tcp_outgoing_address 10.0.36.254 to_ip20


# Access Control Lists
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 21
acl Safe_ports port 443
acl Safe_ports port 70
acl Safe_ports port 210
acl Safe_ports port 1025-65535
acl Safe_ports port 280
acl Safe_ports port 488
acl Safe_ports port 591
acl Safe_ports port 777
acl CONNECT method CONNECT

# Target domain for caching and rate-limit control
acl sand_site dstdomain onlinebooking.sand.telangana.gov.in

# Deny cache for sensitive POST URLs using full path regex (after bump)
acl deny_cache_url urlpath_regex -i \
    MASTERS/HOME\.aspx/CALLSMSLOGINREG \
    MASTERS/HOME\.aspx/CALLREGLOGIN \
    Masters/Home\.aspx/CALLSMSLOGINREG \
    Masters/Home\.aspx/CALLREGLOGIN \
    NEWBOOKING\.aspx/CallSMS \
    NEWBOOKING\.aspx/CallRegister \
    NEWBOOKING\.aspx/lnkCRefreshs \
    NEWBOOKING\.aspx/ChangeVehicleNo \
    NEWBOOKING\.aspx/PopulateDelMandals \
    NEWBOOKING\.aspx/rdselstckpoint \
    NEWBOOKING\.aspx/PopulateGrid \
    BOOKINGHOME\.aspx \
    CALLREGLOGIN \
    CALLSMSLOGINREG

# Prevent Squid from adding proxy headers
via off
forwarded_for delete
request_header_access Via deny all
request_header_access X-Forwarded-For deny all
request_header_access Proxy-Connection deny all
request_header_access Cache-Control deny all

# Access Rules
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localhost
http_access allow all

# SSL Bump Logic â€” bump sand_site, splice everything else
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump peek step1
ssl_bump splice step2 !sand_site
ssl_bump bump step2 sand_site

# Force direct connection for sensitive POST URLs
always_direct allow deny_cache_url

# Deny caching for sensitive POST URLs
cache deny deny_cache_url

# SSL certificate generation
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db -M 4MB
sslcrtd_children 1000 startup=1 idle=1

# Memory-only Cache (disk cache disabled)
cache_mem 512 MB
maximum_object_size_in_memory 100 MB

# Negative caching TTL (cache 404/5xx briefly)
negative_ttl 20 minutes
                                                  
# (disk cache removed)
# cache_dir ufs /var/cache/squid 1000 16 256

# (coredump directory removed)
# coredump_dir /var/cache/squid



# Strict Refresh Patterns (no revalidation for static assets)
refresh_pattern -i \.(jpg|jpeg|png|gif|css|js|min\.js|woff2?|ico)$ 10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload
refresh_pattern -i \.axd(\?.*)?$ 10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload
refresh_pattern sand_site 10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload
refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
refresh_pattern . 0 20% 1440 reload-into-ims

# Connection tuning
quick_abort_min -1
quick_abort_max 0
connect_timeout 300 seconds
read_timeout 300 seconds
pipeline_prefetch 5


# Retry failed requests (including POSTs if safe)
retry_on_error on
connect_retries 10
logformat istlog %{%Y-%m-%dT%H:%M:%S}tl %>a %Ss/%03>Hs %rm %ru %Sh/%<a
access_log /var/log/squid/access.log istlog
