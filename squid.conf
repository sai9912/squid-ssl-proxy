http_port 10.0.46.131:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip21
http_port 10.0.33.135:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip22
http_port 10.0.38.74:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip23
http_port 10.0.41.206:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip24
http_port 10.0.38.208:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip25
http_port 10.0.33.17:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip26
http_port 10.0.41.21:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip27
http_port 10.0.40.87:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip28
http_port 10.0.46.89:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip29
http_port 10.0.47.221:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip30
http_port 10.0.37.93:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip31
http_port 10.0.44.159:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip32
http_port 10.0.42.34:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip33
http_port 10.0.41.100:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip34
http_port 10.0.35.228:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip35
http_port 10.0.43.233:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip36
http_port 10.0.45.105:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip37
http_port 10.0.36.171:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip38
http_port 10.0.33.237:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip39
http_port 10.0.41.174:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip40
http_port 10.0.44.110:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip41
http_port 10.0.47.47:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip42
http_port 10.0.47.241:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip43
http_port 10.0.44.50:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip44
http_port 10.0.47.182:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip45
http_port 10.0.47.54:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip46
http_port 10.0.33.184:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip47
http_port 10.0.43.252:8000 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip48
http_port 10.0.34.63:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip49
http_port 10.0.36.66:8000  ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem name=ip50

# ---- ACLs for new listeners ----
acl to_ip21 myportname ip21
acl to_ip22 myportname ip22
acl to_ip23 myportname ip23
acl to_ip24 myportname ip24
acl to_ip25 myportname ip25
acl to_ip26 myportname ip26
acl to_ip27 myportname ip27
acl to_ip28 myportname ip28
acl to_ip29 myportname ip29
acl to_ip30 myportname ip30
acl to_ip31 myportname ip31
acl to_ip32 myportname ip32
acl to_ip33 myportname ip33
acl to_ip34 myportname ip34
acl to_ip35 myportname ip35
acl to_ip36 myportname ip36
acl to_ip37 myportname ip37
acl to_ip38 myportname ip38
acl to_ip39 myportname ip39
acl to_ip40 myportname ip40
acl to_ip41 myportname ip41
acl to_ip42 myportname ip42
acl to_ip43 myportname ip43
acl to_ip44 myportname ip44
acl to_ip45 myportname ip45
acl to_ip46 myportname ip46
acl to_ip47 myportname ip47
acl to_ip48 myportname ip48
acl to_ip49 myportname ip49
acl to_ip50 myportname ip50

# ---- Outgoing address mapping ----
tcp_outgoing_address 10.0.46.131 to_ip21
tcp_outgoing_address 10.0.33.135 to_ip22
tcp_outgoing_address 10.0.38.74  to_ip23
tcp_outgoing_address 10.0.41.206 to_ip24
tcp_outgoing_address 10.0.38.208 to_ip25
tcp_outgoing_address 10.0.33.17  to_ip26
tcp_outgoing_address 10.0.41.21  to_ip27
tcp_outgoing_address 10.0.40.87  to_ip28
tcp_outgoing_address 10.0.46.89  to_ip29
tcp_outgoing_address 10.0.47.221 to_ip30
tcp_outgoing_address 10.0.37.93  to_ip31
tcp_outgoing_address 10.0.44.159 to_ip32
tcp_outgoing_address 10.0.42.34  to_ip33
tcp_outgoing_address 10.0.41.100 to_ip34
tcp_outgoing_address 10.0.35.228 to_ip35
tcp_outgoing_address 10.0.43.233 to_ip36
tcp_outgoing_address 10.0.45.105 to_ip37
tcp_outgoing_address 10.0.36.171 to_ip38
tcp_outgoing_address 10.0.33.237 to_ip39
tcp_outgoing_address 10.0.41.174 to_ip40
tcp_outgoing_address 10.0.44.110 to_ip41
tcp_outgoing_address 10.0.47.47  to_ip42
tcp_outgoing_address 10.0.47.241 to_ip43
tcp_outgoing_address 10.0.44.50  to_ip44
tcp_outgoing_address 10.0.47.182 to_ip45
tcp_outgoing_address 10.0.47.54  to_ip46
tcp_outgoing_address 10.0.33.184 to_ip47
tcp_outgoing_address 10.0.43.252 to_ip48
tcp_outgoing_address 10.0.34.63  to_ip49
tcp_outgoing_address 10.0.36.66  to_ip50


# Access Control Lists
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 21
acl Safe_ports port 443
acl Safe_ports port 70
acl Safe_ports port 210
acl Safe_ports port 1025-65535
acl Safe_ports port 280
acl Safe_ports port 488
acl Safe_ports port 591
acl Safe_ports port 777
acl CONNECT method CONNECT

# Target domain for caching and rate-limit control
acl sand_site dstdomain onlinebooking.sand.telangana.gov.in

# Deny cache for sensitive POST URLs using full path regex (after bump)
acl deny_cache_url urlpath_regex -i \
    MASTERS/HOME\.aspx/CALLSMSLOGINREG \
    MASTERS/HOME\.aspx/CALLREGLOGIN \
    Masters/Home\.aspx/CALLSMSLOGINREG \
    Masters/Home\.aspx/CALLREGLOGIN \
    NEWBOOKING\.aspx/CallSMS \
    NEWBOOKING\.aspx/CallRegister \
    NEWBOOKING\.aspx/lnkCRefreshs \
    NEWBOOKING\.aspx/ChangeVehicleNo \
    NEWBOOKING\.aspx/PopulateDelMandals \
    NEWBOOKING\.aspx/rdselstckpoint \
    NEWBOOKING\.aspx/PopulateGrid \
    BOOKINGHOME\.aspx \
    CALLREGLOGIN \
    CALLSMSLOGINREG

# Prevent Squid from adding proxy headers
via off
forwarded_for delete
request_header_access Via deny all
request_header_access X-Forwarded-For deny all
request_header_access Proxy-Connection deny all
request_header_access Cache-Control deny all

# Access Rules
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow manager
http_access allow localhost
http_access allow all

# SSL Bump Logic â€” bump sand_site, splice everything else
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump peek step1
ssl_bump splice step2 !sand_site
ssl_bump bump step2 sand_site

# Force direct connection for sensitive POST URLs
always_direct allow deny_cache_url

# Deny caching for sensitive POST URLs
cache deny deny_cache_url

# SSL certificate generation
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db -M 4MB
sslcrtd_children 1000 startup=1 idle=1

# Memory-only Cache (disk cache disabled)
cache_mem 512 MB
maximum_object_size_in_memory 100 MB

# Negative caching TTL (cache 404/5xx briefly)
negative_ttl 10 minutes
                                                  
# (disk cache removed)
# cache_dir ufs /var/cache/squid 1000 16 256

# (coredump directory removed)
# coredump_dir /var/cache/squid



# Strict Refresh Patterns (no revalidation for static assets)
refresh_pattern -i ^https?://onlinebooking\.sand\.telangana\.gov\.in/Images/favicon\.ico(\?.*)?$ 525600 100% 525600 override-expire ignore-no-cache ignore-private ignore-reload ignore-must-revalidate
refresh_pattern -i \.(jpg|jpeg|png|gif|css|js|min\.js|woff2?|ico)$ 10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload
refresh_pattern -i \.axd(\?.*)?$ 10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload
refresh_pattern sand_site 10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload
refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
refresh_pattern . 0 20% 1440 reload-into-ims

# Connection tuning
quick_abort_min -1
quick_abort_max 0

connect_timeout 300 seconds
forward_timeout 300 seconds         # overall cap for upstream attempt(s)
forward_max_tries 5                # total tries across peers/origins
retry_on_error on                  # Retry failed requests (including POSTs if safe)


read_timeout 300 seconds

pipeline_prefetch 5



logformat istlog %{%Y-%m-%dT%H:%M:%S}tl %>a %Ss/%03>Hs %rm %ru %Sh/%<a
access_log /var/log/squid/access.log istlog

logformat debuglog %{%Y-%m-%dT%H:%M:%S}tl %>a %Ss/%03>Hs(%<Hs) %rm %ru %Sh/%<a %<st %<tt
access_log /var/log/squid/debug_access.log debuglog

debug_options ALL,1 20,2 23,2 17,2

