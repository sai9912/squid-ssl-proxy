# ---- Listener Ports ----
http_port 172.31.54.34:8000 ssl-bump \
    generate-host-certificates=on dynamic_cert_mem_cache_size=4MB \
    cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem \
    name=ip1

http_port 172.31.58.112:8000 ssl-bump \
    generate-host-certificates=on dynamic_cert_mem_cache_size=4MB \
    cert=/etc/squid-cert/private.pem key=/etc/squid-cert/private.pem \
    name=ip2

# ---- ACLs for new listeners ----
acl to_ip1 myportname ip1
acl to_ip2 myportname ip2

# ---- Outgoing address mapping ----
tcp_outgoing_address 172.31.54.34 to_ip1
tcp_outgoing_address 172.31.58.112 to_ip2



# Allow persistent reuse of client and server TCP sessions
client_persistent_connections on
server_persistent_connections on

# Keep idle tunnels alive longer (default is 1 minute)
client_idle_pconn_timeout 5 minutes
server_idle_pconn_timeout 5 minutes

# Optional: bump max concurrent connections per client
max_filedescriptors 65535




# Access Control Lists
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 21
acl Safe_ports port 443
acl Safe_ports port 70
acl Safe_ports port 210
acl Safe_ports port 1025-65535
acl Safe_ports port 280
acl Safe_ports port 488
acl Safe_ports port 591
acl Safe_ports port 777
acl CONNECT method CONNECT

# Target domain for caching and rate-limit control
# Match the SNI during SSL bump
acl sand_site ssl::server_name onlinebooking.sand.telangana.gov.in



















# Deny cache for sensitive POST URLs using full path regex (after bump)
acl deny_cache_url urlpath_regex -i \
    MASTERS/HOME\.aspx/CALLSMSLOGINREG \
    MASTERS/HOME\.aspx/CALLREGLOGIN \
    Masters/Home\.aspx/CALLSMSLOGINREG \
    Masters/Home\.aspx/CALLREGLOGIN \
    NEWBOOKING\.aspx/CallSMS \
    NEWBOOKING\.aspx/CallRegister \
    NEWBOOKING\.aspx/lnkCRefreshs \
    NEWBOOKING\.aspx/ChangeVehicleNo \
    NEWBOOKING\.aspx/PopulateDelMandals \
    NEWBOOKING\.aspx/rdselstckpoint \
    NEWBOOKING\.aspx/PopulateGrid \
    BOOKINGHOME\.aspx \
    CALLREGLOGIN \
    CALLSMSLOGINREG



# Prevent Squid from adding proxy headers
via off
forwarded_for delete
request_header_access Via deny all
request_header_access X-Forwarded-For deny all
request_header_access Proxy-Connection deny all
request_header_access Cache-Control deny all

# Access Rules
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow manager
http_access allow localhost
http_access allow all

# SSL Bump Logic â€” bump sand_site, splice everything else
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump peek step1
ssl_bump splice step2 !sand_site
ssl_bump bump step2 sand_site


# Force direct connection for sensitive POST URLs
always_direct allow deny_cache_url

# Deny caching for sensitive POST URLs
cache deny deny_cache_url




# SSL certificate generation
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db -M 4MB
sslcrtd_children 1000 startup=1 idle=1

# Memory-only Cache (disk cache disabled)
cache_mem 512 MB
maximum_object_size_in_memory 100 MB

# Negative caching TTL (cache 404/5xx briefly)
negative_ttl 2 seconds


# (disk cache removed)
# cache_dir ufs /var/cache/squid 1000 16 256

# (coredump directory removed)
# coredump_dir /var/cache/squid



# Strict Refresh Patterns (no revalidation for static assets)

# ---- Static asset rules ----
refresh_pattern -i \.png$      10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload
refresh_pattern -i \.gif$      10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload
refresh_pattern -i \.ico$      10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload
refresh_pattern -i \.css$      10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload
refresh_pattern -i \.js$       10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload
refresh_pattern -i \.min\.js$  10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload
refresh_pattern -i \.axd(\?.*)?$ 10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload ignore-must-revalidate ignore-authentication
refresh_pattern -i /Masters/Uptime\.aspx$ 10080 100% 10080 override-expire ignore-no-cache ignore-private ignore-reload ignore-must-revalidate ignore-authentication



# Connection tuning
quick_abort_min -1
quick_abort_max 0

connect_timeout 900 seconds
connect_retries 10
forward_timeout 900 seconds         # overall cap for upstream attempt(s)
forward_max_tries 5                # total tries across peers/origins
retry_on_error on                  # Retry failed requests (including POSTs if safe)


read_timeout 900 seconds

pipeline_prefetch 2



logformat istlog %{%Y-%m-%dT%H:%M:%S}tl %>a %Ss/%03>Hs %rm %ru %Sh/%<a
access_log /var/log/squid/access.log istlog

#logformat debuglog %{%Y-%m-%dT%H:%M:%S}tl %>a %Ss/%03>Hs(%<Hs) %rm %ru %Sh/%<a %<st %<tt
#access_log /var/log/squid/debug_access.log debuglog

#debug_options ALL,1 20,2 23,2 17,2
